<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>STOMP Chat (Query Token)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 720px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .row { display: flex; gap: 8px; margin: 8px 0; }
        .row > * { flex: 1; }
        input, button { padding: 8px; }
        .log { margin-top: 16px; height: 260px; overflow-y: auto; background:#f7f7f7; border:1px solid #ddd; padding:10px; }
        .status { margin: 8px 0; font-weight: bold; }
        .connected { color: green; }
        .disconnected { color: red; }
    </style>
</head>
<body>
<div class="container">
    <h2>STOMP Chat (ì¿¼ë¦¬ìŠ¤íŠ¸ë§ JWT)</h2>

    <div class="row">
        <input id="jwt" placeholder="JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”" />
        <button id="connect">Connect</button>
        <button id="disconnect" disabled>Disconnect</button>
    </div>

    <div class="status">Status: <span id="status" class="disconnected">Disconnected</span></div>

    <hr />

    <div class="row">
        <input id="receiverId" type="number" placeholder="ë°›ëŠ” ì‚¬ëŒ ID (receiveId)" />
        <input id="message" placeholder="ë©”ì‹œì§€ ë‚´ìš©" />
        <button id="send" disabled>Send</button>
    </div>

    <div class="log" id="log"></div>
</div>

<script>
    const $ = (id) => document.getElementById(id);
    const logBox = $("log");
    function log(msg) {
      const p = document.createElement("p");
      p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logBox.appendChild(p);
      logBox.scrollTop = logBox.scrollHeight;
    }

    const statusEl = $("status");
    const connectBtn = $("connect");
    const disconnectBtn = $("disconnect");
    const sendBtn = $("send");
    const jwtInput = $("jwt");
    const receiverInput = $("receiverId");
    const messageInput = $("message");

    let stompClient = null;
    let sock = null;

    function setStatus(connected) {
      if (connected) {
        statusEl.textContent = "Connected";
        statusEl.className = "connected";
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        sendBtn.disabled = false;
      } else {
        statusEl.textContent = "Disconnected";
        statusEl.className = "disconnected";
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        sendBtn.disabled = true;
      }
    }

    connectBtn.addEventListener("click", () => {
      const token = jwtInput.value.trim();
      if (!token) {
        alert("JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      // âœ… ì¿¼ë¦¬ìŠ¤íŠ¸ë§ìœ¼ë¡œ í† í° ì „ë‹¬ (ë¸Œë¼ìš°ì €/SockJS í™˜ê²½ì—ì„œ í—¤ë” ì „ë‹¬ ì œì•½ íšŒí”¼)
      const url = "http://localhost:8080/ws-stomp?token=" + encodeURIComponent(token);
      sock = new SockJS(url);
      stompClient = Stomp.over(sock);

      // ì„ íƒ: ì½˜ì†” ë¡œê·¸ ì¤„ì´ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ë¼ì¸ í™œì„±í™”
      // stompClient.debug = () => {};

      // í•˜íŠ¸ë¹„íŠ¸(ì„ íƒ)
      stompClient.heartbeat.outgoing = 10000; // 10s
      stompClient.heartbeat.incoming = 10000; // 10s

      stompClient.connect(
        {}, // í—¤ë” ë¹„ì›€: ì¿¼ë¦¬ìŠ¤íŠ¸ë§ìœ¼ë¡œ ì¸ì¦
        (frame) => {
          log("Connected: " + frame);
          setStatus(true);

          // ë³¸ì¸ ì „ìš© í êµ¬ë… (/user/queue/...)
          stompClient.subscribe("/user/queue/chat/message", (message) => {
            try {
              const body = JSON.parse(message.body);
              log("ğŸ“© Received: " + JSON.stringify(body));
            } catch (e) {
              log("ğŸ“© Received (raw): " + message.body);
            }
          });
        },
        (error) => {
          log("âŒ Connection error: " + error);
          setStatus(false);
        }
      );
    });

    disconnectBtn.addEventListener("click", () => {
      try {
        if (stompClient && stompClient.connected) {
          stompClient.disconnect(() => {
            log("Disconnected.");
            setStatus(false);
          });
        } else if (sock) {
          sock.close();
          setStatus(false);
        } else {
          setStatus(false);
        }
      } catch (e) {
        log("Disconnect error: " + e.message);
        setStatus(false);
      }
    });

    window.addEventListener("beforeunload", () => {
      if (stompClient && stompClient.connected) {
        stompClient.disconnect();
      }
    });

    sendBtn.addEventListener("click", () => {
      if (!stompClient || !stompClient.connected) {
        log("âš ï¸ Not connected. Connect first.");
        return;
      }
      const receiveId = receiverInput.value.trim();
      const msg = messageInput.value.trim();
      if (!receiveId || !msg) {
        alert("ë°›ëŠ” ì‚¬ëŒ IDì™€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      const payload = {
        receiveId: Number(receiveId),
        message: msg
      };

      stompClient.send("/app/chat/sendMessage", {}, JSON.stringify(payload));
      log("ğŸ“¤ Sent: " + JSON.stringify(payload));
      messageInput.value = "";
      messageInput.focus();
    });
</script>
</body>
</html>
